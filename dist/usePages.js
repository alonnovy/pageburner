"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _jsxRuntime=require("react/jsx-runtime");var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{"default":mod};};Object.defineProperty(exports,"__esModule",{value:true});exports.usePages=void 0;var react_1=__importDefault(require("react"));var react_2=require("react");var lodash_1=__importDefault(require("lodash"));var react_3=require("react");var page_1=require("./page");var react_native_1=require("react-native");function usePages(){var initialPages=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];var priorPagesRef=react_3.useRef(lodash_1.default.isArray(initialPages)?initialPages:[initialPages]);var _react_2$useState=react_2.useState(0),_react_2$useState2=(0,_slicedToArray2.default)(_react_2$useState,2),setExpiredAt=_react_2$useState2[1];var pages=lodash_1.default.isArray(initialPages)?initialPages:[initialPages];var pageAnnotations={};var pageAnimations=react_3.useRef({}).current;var pageDismissFunctions={};var pageOptions={};var priorPages=priorPagesRef.current;var isPriorPage=function isPriorPage(page){return!!priorPages.find(function(p){return p.key===page.key;});};priorPagesRef.current=[];var pushPage=function pushPage(page,options){if(page.key===undefined||page.key===null){throw new Error("Undefined or null page key");}if(!isPriorPage(page)){pageAnnotations[page.key]="new";}pageAnimations[page.key]={incoming:["slideFromRight"],outgoing:["slideToRight"],speed:"fast"};pageOptions[page.key]=options||{};!!(options===null||options===void 0?void 0:options.background)&&pages.push(options===null||options===void 0?void 0:options.background);pages.push(page);var onDismiss=function onDismiss(fn){pageDismissFunctions[page.key]=fn;};var animate=function animate(_ref){var _ref$incoming=_ref.incoming,incoming=_ref$incoming===void 0?"slideFromRight":_ref$incoming,_ref$outgoing=_ref.outgoing,outgoing=_ref$outgoing===void 0?"slideToRight":_ref$outgoing,_ref$speed=_ref.speed,speed=_ref$speed===void 0?"fast":_ref$speed;pageAnimations[page.key]={incoming:lodash_1.default.isArray(incoming)?incoming:[incoming],outgoing:lodash_1.default.isArray(outgoing)?outgoing:[outgoing],speed:speed};return{onDismiss:onDismiss};};return{animate:animate,onDismiss:onDismiss};};return[{show:pushPage,when:function when(predicate){if(predicate){return{show:pushPage};}else{return{show:function show(){return{animate:function animate(spec){return{onDismiss:function onDismiss(onDismissed){}};},onDismiss:function onDismiss(onDismissed){}};}};}}},function(){var _ref2=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},zIndex=_ref2.zIndex;var removedPages=priorPages.filter(function(prior){return!pages.find(function(current){return current.key===prior.key;});});removedPages.forEach(function(pg){pageAnnotations[pg.key]="removed";});pages=lodash_1.default.unionWith(pages,removedPages,function(p1,p2){return p1.key===p2.key;});return(0,_jsxRuntime.jsx)(_jsxRuntime.Fragment,{children:!!pages.length&&(0,_jsxRuntime.jsx)(react_native_1.View,{style:{overflow:"hidden",position:"absolute",top:0,left:0,right:0,bottom:0,zIndex:zIndex},children:pages.map(function(pg,idx){var _a,_b,_c;return(0,_jsxRuntime.jsx)(react_native_1.View,{style:{position:"absolute",zIndex:idx,width:"100%",height:"100%",backgroundColor:!!pageOptions[pg.key].background?"transparent":"rgba(0,0,0,0.4)"},children:(0,_jsxRuntime.jsx)(page_1.Page,{animation:pageAnnotations[pg.key]==="new"?(_a=pageAnimations[pg.key])===null||_a===void 0?void 0:_a.incoming:pageAnnotations[pg.key]==="removed"?(_b=pageAnimations[pg.key])===null||_b===void 0?void 0:_b.outgoing:"none",animationSpeed:(_c=pageAnimations[pg.key])===null||_c===void 0?void 0:_c.speed,onAnimationFinished:function onAnimationFinished(){if(pageAnnotations[pg.key]!=="removed"){priorPagesRef.current.push(pg);}else{setTimeout(function(){setExpiredAt(Date.now());},1);}},children:(0,_jsxRuntime.jsxs)(_jsxRuntime.Fragment,{children:[(0,_jsxRuntime.jsx)(react_native_1.Pressable,{onPress:function onPress(ev){if(pageDismissFunctions[pg.key]){pageDismissFunctions[pg.key]();setExpiredAt(Date.now());}},style:{position:"absolute",top:0,left:0,right:0,bottom:0}},"pg-dismiss-"+idx),pg]})},"pg-"+pg.key)},"pg-background-"+pg.key);})},"flow-container")});}];}exports.usePages=usePages;